events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Unity WebGL MIME 타입
    types {
        application/wasm                  wasm;
        application/octet-stream          data;
        application/javascript            js;
    }

    # 업스트림 서비스 정의
    upstream simulation_api {
        server simulation-api:5000;
    }

    upstream n8n_service {
        server n8n:5678;
    }

    # 요청 크기 제한 (LLM 응답 포함)
    client_max_body_size 10m;

    # gzip 압축 (Unity WebGL 에셋 전송 최적화)
    gzip on;
    gzip_types text/plain text/css application/javascript application/json;
    gzip_min_length 1000;

    server {
        listen 80;
        server_name _;  # 모든 도메인/IP 수신

        # ── React 프론트엔드 정적 파일 루트 ──────────────────────────
        root /usr/share/nginx/html;

        # ── SimulationEngine API ──────────────────────────────────
        location /api/ {
            proxy_pass         http://simulation_api;
            proxy_http_version 1.1;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_read_timeout 60s;

            # CORS (Unity WebGL → API 직접 호출 지원)
            add_header Access-Control-Allow-Origin  "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
            if ($request_method = OPTIONS) { return 204; }
        }

        # ── n8n 워크플로우 관리 UI ────────────────────────────────
        location /n8n/ {
            rewrite ^/n8n/(.*) /$1 break;
            proxy_pass         http://n8n_service;
            proxy_http_version 1.1;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   Upgrade           $http_upgrade;
            proxy_set_header   Connection        "upgrade";
        }

        # ── n8n Webhook 단축 경로 ─────────────────────────────────
        location /webhook/ {
            proxy_pass         http://n8n_service/webhook/;
            proxy_http_version 1.1;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_read_timeout 120s;

            add_header Access-Control-Allow-Origin  "*" always;
            add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type" always;
            if ($request_method = OPTIONS) { return 204; }
        }

        # ── 헬스체크 ─────────────────────────────────────────────
        location /health {
            proxy_pass http://simulation_api/api/health;
        }

        # ── Unity WebGL 빌드 파일 (gzip 압축 에셋) ───────────────
        location /unity/Build/ {
            # .gz 확장자 파일에 Content-Encoding 헤더 추가
            location ~* \.js\.gz$ {
                add_header Content-Encoding gzip;
                add_header Content-Type    application/javascript;
            }
            location ~* \.wasm\.gz$ {
                add_header Content-Encoding gzip;
                add_header Content-Type    application/wasm;
            }
            location ~* \.data\.gz$ {
                add_header Content-Encoding gzip;
                add_header Content-Type    application/octet-stream;
            }
        }

        # ── React SPA (모든 나머지 경로) ─────────────────────────
        location / {
            try_files $uri $uri/ /index.html;
        }
    }
}
