# StructFlow EC2 배포용 Docker Compose
# 실행: docker compose up -d
#
# 서비스 구성:
#   simulation-api  — .NET 10 SimulationEngine REST API (:5000 내부)
#   n8n             — 워크플로우 자동화 (:5678 내부)
#   nginx           — 리버스 프록시 (:80 외부 공개)

version: "3.9"

services:

  # ── SimulationEngine API ──────────────────────────────────────────
  simulation-api:
    image: ${SIMULATION_IMAGE:-structflow-api:latest}
    container_name: structflow-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
    expose:
      - "5000"
    healthcheck:
      test: ["CMD", "bash", "-c", "cat /dev/null > /dev/tcp/localhost/5000"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - structflow-net

  # ── n8n 워크플로우 ─────────────────────────────────────────────────
  n8n:
    image: n8nio/n8n:latest
    container_name: structflow-n8n
    restart: unless-stopped
    environment:
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - WEBHOOK_URL=${N8N_WEBHOOK_URL:-http://localhost/n8n/}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_SECURE_COOKIE=false
    volumes:
      - n8n_data:/home/node/.n8n
    ports:
      - "5678:5678"
    networks:
      - structflow-net
    depends_on:
      simulation-api:
        condition: service_healthy

  # ── Nginx 리버스 프록시 + 프론트엔드 정적 파일 서빙 ─────────────────
  nginx:
    image: nginx:alpine
    container_name: structflow-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend/dist:/usr/share/nginx/html:ro
      # unity 빌드는 frontend/dist/unity/ 안에 직접 복사해서 사용
      # (중첩 마운트 불가 → dist 볼륨 하나로 통합)
    networks:
      - structflow-net
    depends_on:
      - simulation-api
      - n8n

volumes:
  n8n_data:
    driver: local

networks:
  structflow-net:
    driver: bridge
